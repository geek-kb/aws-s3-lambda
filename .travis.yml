dist: focal
env:
  global:
    lambda_name=s3-bucket-watcher
    ecr_repo_name=itaig
language: minimal
services:
- docker
before_install:
- pip install -U pip
- pip install jq
- curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
- unzip awscliv2.zip &>/dev/null
- sudo ./aws/install
- aws --version
- export PATH=$PATH:$HOME/.local/bin
- docker build -t ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/itaig:latest .
after_success:
- aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
- docker push ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ecr_repo_name}:latest
- ecr_image_sha=$(aws ecr list-images --repository-name itaig | jq -r '.imageIds[] | select(.imageTag=="latest") .imageDigest')
- ecr_image_uri="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/itaig@${ecr_image_sha}"
- aws lambda update-function-code --function-name ${lambda_name} --image-uri ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ecr_repo_name}@${ecr_image_sha}
